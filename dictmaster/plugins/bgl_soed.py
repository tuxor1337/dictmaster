
import re
import os
import unicodedata
import sys

from pyquery import PyQuery as pq
from lxml import etree

from pyglossary.glossary import Glossary

from dictmaster.replacer import *
from dictmaster.plugins.bgl import BglProcessor, Plugin as BglPlugin

symbol_img = {}

image_to_html = {
    "033E5C32.png": "<num>36</num>",
    "067AD824.png": "Œ∂",
    "06B6155D.png": "<num>29</num>",
    "078CEC83.png": "<num>65</num>",
    "07CBF0B5.png": "<num>12</num>",
    "0B046617.png": "<num>35</num>",
    "0D091428.png": "ƒÅ‚Ä≤",
    "0E220CA9.png": "<num>54</num>",
    "0F0935C6.png": "<num>72</num>",
    "10154555.png": "<num>20</num>",
    "12AEDB40.png": "<num>62</num>",
    "13878E66.png": "…õÃÉ",
    "14D02161.png": "<num>60</num>",
    "15DDFC2F.png": "<num>11</num>",
    "16A4D91A.png": "<num>58</num>",
    "1B562ECC.png": "<num>6</num>",
    "1CC23B58.png": "«Ω",
    "1E820912.png": "·πõ",
    "1E904884.png": "ƒù",
    "1EC80CDC.png": "<num>4</num>",
    "1F32A8C1.png": "<num>40</num>",
    "22630041.png": "√Ω",
    "23668C38.png": "<num>70</num>",
    "25AEC118.png": "<num>63</num>",
    "2D03EE32.png": "<num>33</num>",
    "2D0A6491.png": "<num>8</num>",
    "2DB704D8.png": "·π£",
    "2E5132D5.png": "<num>50</num>",
    "2ECA037B.png": "<num>48</num>",
    "33664A42.png": "<u>k</u>",
    "36DE5C0E.png": "<num>27</num>",
    "36E5D4EC.png": "<num>71</num>",
    "3BD7D11B.png": "Œ±",
    "3E9BFA00.png": "<num>28</num>",
    "40439ED5.png": "<u>p</u>",
    "4465D21F.png": "<num>19</num>",
    "448D5880.png": "<num>38</num>",
    "46C75327.png": "<num>41</num>",
    "4A83246D.png": "<num>17</num>",
    "4A91A94C.png": "<num>24</num>",
    "4D6F6F17.png": "<num>55</num>",
    "4DA4D060.png": "Œû",
    "4E140796.png": "Œ≤",
    "51048A3C.png": "<num>9</num>",
    "5196E2B9.png": "a·πá",
    "54913B96.png": "<num>39</num>",
    "54B57139.png": "<num>16</num>",
    "575A1B95.png": "mÃÄ",
    "5CEA5523.png": "»•",
    "5DA84A2B.png": "<num>73</num>",
    "601C9445.png": "üü•",
    "613E6948.png": "<num>52</num>",
    "61413BDE.png": "·∏•",
    "64D6FD30.png": "<num>7</num>",
    "65540E1F.png": "<num>75</num>",
    "655E48A1.png": "<num>66</num>",
    "68C52A72.png": "<num>53</num>",
    "6AF2E0F1.png": "<num>42</num>",
    "6B13855A.gif": "‚Æï",
    "6B316968.png": "<num>22</num>",
    "6B7E0D98.png": "<num>76</num>",
    "6BBB9869.png": "·∏∑",
    "6D960BDB.png": "<num>15</num>",
    "73115627.png": "y",
    "73537FF9.png": "<num>68</num>",
    "73BCCB79.png": "Àù",
    "74D4394D.png": "<num>74</num>",
    "75068C39.png": "…îÃÉ",
    "7530B1E9.png": "·∏ç",
    "761C48F2.png": "yÃÑ",
    "79D460E7.png": "ƒ±",
    "7A57D6A6.png": "·π≠",
    "7A9F3E8D.png": "<num>23</num>",
    "7BC516DA.png": "∆ø",
    "7BD4F2D2.png": "«µ",
    "7CFAAC1C.png": "<num>44</num>",
    "80723112.png": "<num>25</num>",
    "878C32BA.png": "Œô",
    "8B4F6768.png": "<num>13</num>",
    "8DE97389.png": "≈Ç",
    "8EE91A76.png": "≈∑",
    "911C7ED6.png": "<num>43</num>",
    "92C42472.png": "<num>56</num>",
    "94E6452A.png": "<num>67</num>",
    "95D5C9C1.png": "<num>1</num>",
    "97253D35.png": "<num>47</num>",
    "9D50910E.png": "·πÉ",
    "9F2C548A.png": "¬®",
    "A206E8EF.png": "<num>57</num>",
    "A2F0D98E.png": "<num>69</num>",
    "A33C7BD5.png": "<num>2</num>",
    "A7572633.png": "<num>34</num>",
    "AA37F35E.png": "‚Äã…•ÃÑ",
    "ABACDED3.png": "<num>26</num>",
    "AC1CC18C.png": "·πá",
    "B1DAF5F2.png": "<num>30</num>",
    "B30C8A60.png": "<num>46</num>",
    "B665E39E.png": "<num>3</num>",
    "B70DD809.png": "<num>10</num>",
    "BA210F37.png": "<num>51</num>",
    "BAACA594.png": "<num>45</num>",
    "BD30FB9E.png": "‚Ä†",
    "BE7CFA23.png": "·∏á",
    "C3788D34.png": "œá",
    "C6D1B5ED.png": "oÃÉ",
    "C7273B76.png": " éÃã",
    "CA410C78.png": "«∑",
    "CB62C898.png": "<num>77</num>",
    "CBAEB70A.png": "<num>59</num>",
    "D0404B0F.png": "œÄ",
    "D9B24F2F.png": "·πØ",
    "DAE5A796.png": "<num>64</num>",
    "DB76441D.png": "<num>5</num>",
    "DD7A55CE.png": "·∏è",
    "DF9CF88F.png": "√£",
    "E015965B.png": "<num>37</num>",
    "E5697797.png": "Œæ",
    "E8834AC7.png": "<num>31</num>",
    "EDFE4565.png": "<num>21</num>",
    "EE97FFFE.png": "<num>14</num>",
    "F1AEE882.png": "‚Äñ",
    "F85AA2C3.png": "<num>32</num>",
    "F91A17C6.png": "·πá",
    "F9B6D84F.png": " é",
    "FB3FB916.png": "<num>61</num>",
    "FBD9D165.png": "‚Äã≈ì",
    "FE0C60F5.png": "<num>49</num>",
    "FEB6347F.png": "<num>18</num>",
}

entity_table = {
    "3on4": "¬æ",
    "Asg": "∆∑",
    "Bantuo": "&lsaquo;Bantuo&rsaquo;",
    "Car": "&lsaquo;Car&rsaquo;",
    "Cced": "√á",
    "Chirho": "‚òß",
    "Csigma": "œö",
    "Csub": "&sube;",
    "Edh": "√ê",
    "Hbrbl": "·∏™",
    "Iasper": "·ºπ",
    "Iasperacu": "·ºΩ",
    "Ilenis": "·º∏",
    "Ilenisacu": "·ºº",
    "Integ": "‚à´",
    "Koppa": "œû",
    "Lbar": "≈Å",
    "Naira": "N",
    "Nplus": "N",
    "Obar": "√ò",
    "Sced": "≈û",
    "Summ": "‚àë",
    "Th": "√û",
    "Thbar": "&lsaquo;Thbar&rsaquo;",
    "Tse": "–¶",
    "Ubox": "&lsaquo;Ubox&rsaquo;",
    "Wyn": "∆ø",
    "Ygh": "∆∑",
    "Zh": "∆∑",
    "a": "a",
    "aacuced": "&lsaquo;aacuced&rsaquo;",
    "aced": "&lsaquo;aced&rsaquo;",
    "albrtime": "&lsaquo;albrtime&rsaquo;",
    "aleph": "&alefsym;",
    "alphagra": "·Ω∞",
    "angle": "‚à†",
    "ankh": "‚ò•",
    "ante": "a",
    "aonq": "&lsaquo;aonq&rsaquo;",
    "appreq": "‚âÉ",
    "aquar": "‚ôí",
    "arDadfull": "ÿ∂",
    "arHa": "ÿ≠",
    "arTa": "ÿ™",
    "arain": "ÿπ",
    "arainfull": "ÿπ",
    "aralif": "ÿß",
    "arba": "ÿ®",
    "ardal": "Ô∫©",
    "arha": "Ÿá",
    "aries": "‚ôà",
    "arnun": "ŸÜ",
    "arnunfull": "ŸÜ",
    "arpa": "Ÿá",
    "arqoph": "ŸÇ",
    "arshinfull": "ÿ¥",
    "arta": "ÿ™",
    "artafull": "ÿ™",
    "artha": "ÿ´",
    "arwaw": "Ÿà",
    "arya": "Ÿä",
    "aryafull": "Ÿä",
    "arzero": "Ÿ†",
    "asg": " í",
    "assert": "‚ä¢",
    "assyrH": "·∏™",
    "astm": "‚ÅÇ",
    "at": "@",
    "ayin": "ÿπ",
    "ayindotab": "Ôªç",
    "ayinold": "Ôªã",
    "b1": "-",
    "b2": "=",
    "b3": "‚â°",
    "bantuo": "&lsaquo;bantuo&rsaquo;",
    "bbar": "∆Ä",
    "bbc1": "|",
    "bbc2": "‚Äñ",
    "bbl1": "&lsaquo;bbl1&rsaquo;",
    "bbr1": "&lsaquo;bbr1&rsaquo;",
    "bbr2": "&lsaquo;bbr2&rsaquo;",
    "bcop1": "&lsaquo;bcop1&rsaquo;",
    "bcop2": "&lsaquo;bcop2&rsaquo;",
    "bcurl": "b",
    "benchm": "&lsaquo;benchm&rsaquo;",
    "bigobl": "/",
    "blambda": "ùõå",
    "bLambda": "ùö≤",
    "blC": "C",
    "blJ": "J",
    "blU": "U",
    "blb": "b",
    "blozenge": "‚óä",
    "bly": "y",
    "bra": "&lsaquo;bra&rsaquo;",
    "bslash": "\\",
    "bsquare": "‚ñ†",
    "btc1": "&lsaquo;btc1&rsaquo;",
    "btc2": "&lsaquo;btc2&rsaquo;",
    "btl1": "&lsaquo;btl1&rsaquo;",
    "btr1": "&lsaquo;btr1&rsaquo;",
    "btr2": "&lsaquo;btr2&rsaquo;",
    "btril": "‚óÄ",
    "btrir": "‚ñ∂",
    "burman": "&lsaquo;burman&rsaquo;",
    "c": "c",
    "cab": "‚å™",
    "canc": "‚ôã",
    "capr": "‚ôë",
    "car": "‚Ü∫",
    "caret": "^",
    "cb": "}",
    "cbigb": "}",
    "cbigpren": ")",
    "cbigsb": "]",
    "cced": "√ß",
    "cdsb": "„Äõ",
    "chsign": "—ä",
    "circa": "c",
    "circbl": "Ã•",
    "circle": "‚óã",
    "circledot": "‚äô",
    "cjat": "b",
    "clenis": "&lsaquo;clenis&rsaquo;",
    "click": " ñ",
    "club": "‚ô£",
    "comtime": "C",
    "congr": "&cong;",
    "conj": "‚òå",
    "cprt": "¬©",
    "cq": "'",
    "cqq": "‚Äù",
    "cross": "‚ú†",
    "crotchet": "‚ô©",
    "csb": "]",
    "cssign": "—å",
    "ctlig": "&lsaquo;ctlig&rsaquo;",
    "cursived": "&part;",
    "cyrO": "–û",
    "cyrP": "–ü",
    "cyra": "–∞",
    "cyrd": "–¥",
    "cyre": "–µ",
    "cyrhard": "—ä",
    "cyrjat": "—£",
    "cyrm": "–º",
    "cyrn": "–Ω",
    "cyrr": "—Ä",
    "cyrsoft": "—å",
    "cyrt": "—Ç",
    "cyry": "—ã",
    "dag": "‚Ä†",
    "dbar": "ƒë",
    "dblar": "‚áã",
    "dblgt": "‚â´",
    "dbllt": "‚â™",
    "dced": "d",
    "dd": "‚Ä•",
    "ddag": "‚Ä°",
    "ddd": "&hellip;",
    "decr": "‚Üì",
    "dele": "d",
    "descnode": "‚òã",
    "devdh": "‡§ß",
    "devph": "‡§´",
    "devrfls": "‡§∑",
    "devrt": "‡§ü",
    "devrth": "‡§†",
    "devt": "‡§§",
    "devth": "‡§•",
    "diam": "‚ô¢",
    "diamond": "‚ô¢",
    "digamma": "œù",
    "Digamma": "œú",
    "ditto": "&lsaquo;ditto&rsaquo;",
    "div": "√∑",
    "dlessi": "ƒ±",
    "dlessj1": "j",
    "dlessj2": "j",
    "dlessj3": "j",
    "dollar": "$",
    "drachm": " í",
    "dubh": "-",
    "duplong1": "&lsaquo;duplong1&rsaquo;",
    "duplong2": "&lsaquo;duplong2&rsaquo;",
    "earth": "‚ôÅ",
    "edh": "√∞",
    "egchi": "&lsaquo;egchi&rsaquo;",
    "eggamma1": "&lsaquo;eggamma1&rsaquo;",
    "eggamma2": "&lsaquo;eggamma2&rsaquo;",
    "egiota": "&lsaquo;egiota&rsaquo;",
    "egkappa": "&lsaquo;egkappa&rsaquo;",
    "eglambda": "&lsaquo;eglambda&rsaquo;",
    "egmu1": "&lsaquo;egmu1&rsaquo;",
    "egmu2": "&lsaquo;egmu2&rsaquo;",
    "egnu1": "&lsaquo;egnu1&rsaquo;",
    "egnu2": "&lsaquo;egnu2&rsaquo;",
    "egpi1": "&lsaquo;egpi1&rsaquo;",
    "egpi2": "&lsaquo;egpi2&rsaquo;",
    "egpi3": "&lsaquo;egpi3&rsaquo;",
    "egrho1": "&lsaquo;egrho1&rsaquo;",
    "egrho2": "&lsaquo;egrho2&rsaquo;",
    "egsampi": "&lsaquo;egsampi&rsaquo;",
    "egsan": "&lsaquo;egsan&rsaquo;",
    "egsigma1": "&lsaquo;egsigma1&rsaquo;",
    "egsigma2": "&lsaquo;egsigma2&rsaquo;",
    "egxi1": "&lsaquo;egxi1&rsaquo;",
    "egxi2": "&lsaquo;egxi2&rsaquo;",
    "egxi3": "&lsaquo;egxi3&rsaquo;",
    "egy3": "&lsaquo;egy3&rsaquo;",
    "egyasper": "&lsaquo;egyasper&rsaquo;",
    "elatS": "&lsaquo;elatS&rsaquo;",
    "elatc1": "&lsaquo;elatc1&rsaquo;",
    "elatc2": "&lsaquo;elatc2&rsaquo;",
    "elatg1": "&lsaquo;elatg1&rsaquo;",
    "elatg2": "&lsaquo;elatg2&rsaquo;",
    "elem": "‚àä",
    "em": "‚Äî",
    "emem": "‚Äï",
    "en": "‚Äì",
    "equil": "‚áã",
    "ergo": "‚à¥",
    "eszett": "√ü",
    "expon": "‚Üë",
    "fac": "&lsaquo;fac&rsaquo;",
    "fact": "!",
    "fata": "…ë",
    "fatatilde": "&lsaquo;fatatilde&rsaquo;",
    "fatpara": "¬∂",
    "female": "‚ôÄ",
    "ffilig": "Ô¨É",
    "ffllig": "Ô¨Ñ",
    "flat": "‚ô≠",
    "fllig": "Ô¨Ç",
    "fourd": "&lsaquo;fourd&rsaquo;",
    "frE": "E",
    "frL": "L",
    "frR": "R",
    "frakB": "B",
    "frakE": "&lsaquo;frakE&rsaquo;",
    "frakF": "&lsaquo;frakF&rsaquo;",
    "frakG": "G",
    "frakH": "H",
    "frakI": "I",
    "frakK": "&lsaquo;frakK&rsaquo;",
    "frakL": "&lsaquo;frakL&rsaquo;",
    "frakM": "M",
    "frakP": "&lsaquo;frakP&rsaquo;",
    "frakR": "&real;",
    "frakU": "U",
    "frakX": "X",
    "frakY": "Y",
    "frakg": "&lsaquo;frakg&rsaquo;",
    "frakh": "h",
    "fs": " ",
    "fsigma": "œÇ",
    "fslash": "/",
    "gbbelow": "g",
    "gjat": "",
    "glagjat": "—ß",
    "glagjer": "&lsaquo;glagjeri&rsaquo;",
    "glagjeri": "&lsaquo;glagjeri&rsaquo;",
    "glagjeru": "&lsaquo;glagjeru&rsaquo;",
    "gjeri": "‚∞†",
    "gjeru": "‚∞ü",
    "glots": "ÀÄ",
    "half": "&frac12;",
    "halft": "‚åà",
    "hamza": "Ô∫Ä",
    "hash": "#",
    "hatpath": "÷≤",
    "hatqam": "÷≥",
    "hatseg": "÷±",
    "hbar": "ƒß",
    "hbrbl": "·∏´",
    "heart": "‚ô°",
    "hebaleph": "◊ê",
    "hebayin": "◊¢",
    "hebbet": "◊ë",
    "hebbeth": "◊ë",
    "hebcheth": "◊ó",
    "hebdaleth": "◊ì",
    "hebgimel": "◊í",
    "hebhe": "◊î",
    "hebkaph": "◊õ",
    "heblamed": "◊ú",
    "hebmem": "◊û",
    "hebnun": "◊†",
    "hebnunfin": "◊ü",
    "hebpe": "◊§",
    "hebpedag": "◊£",
    "hebqoph": "◊ß",
    "hebresh": "◊®",
    "hebshin": "◊©",
    "hebtav": "◊™",
    "hebteth": "◊ò",
    "hebtsade": "◊¶",
    "hebwaw": "◊ï",
    "hebyod": "◊ô",
    "hebzayin": "◊ñ",
    "hgz": " í",
    "hireq": "÷¥",
    "horizE": "E",
    "horizP": "P",
    "horizS": "‚àΩ",
    "horizT": "‚ä£",
    "horizb": "{",
    "huncU": "&lsaquo;huncU&rsaquo;",
    "hypolem": "&lsaquo;hypolem&rsaquo;",
    "ia": "Œ±",
    "iasper": "·º±",
    "iasperacu": "·ºµ",
    "iasperfrown": "·º∑",
    "ib": "Œ≤",
    "ibar": "…®",
    "iced": "&lsaquo;iced&rsaquo;",
    "id": "Œ¥",
    "ident": "‚â°",
    "ie": "Œµ",
    "ifflig": "Ô¨Ä",
    "ifilig": "Ô¨Å",
    "ifrbl": "&lsaquo;ifrbl&rsaquo;",
    "ig": "Œ≥",
    "igra": "√¨",
    "ih": "Œ∑",
    "ii": "Œπ",
    "ik": "Œ∫",
    "ilenis": "·º∞",
    "ilenisacu": "·º¥",
    "ilenisfrown": "·º∂",
    "ilenismac": "&lsaquo;ilenismac&rsaquo;",
    "ilenismacacu": "&lsaquo;ilenismacacu&rsaquo;",
    "implies": "‚áí",
    "index": "‚òû",
    "integ": "‚à´",
    "intsec": "‚à©",
    "intset": "‚Ñ§",
    "invpri": "Àè",
    "iq": "œà",
    "istlig": "Ô¨Ü",
    "isub": "œµ",
    "italU": "&lsaquo;italU&rsaquo;",
    "iz": "Œ∂",
    "jup": "‚ôÉ",
    "koppa": "œü",
    "lar": "‚Üê",
    "lbar": "≈Ç",
    "lbelt": "&lsaquo;lbelt&rsaquo;",
    "lcircbl": "&lsaquo;lcircbl&rsaquo;",
    "lenis": "·æø",
    "leo": "‚ôå",
    "lhalfbr": "‚åà",
    "lhshoe": "‚äÉ",
    "libra": "‚ôé",
    "llswing": "&lsaquo;llswing&rsaquo;",
    "lm": "Àê",
    "logicand": "‚àß",
    "logicor": "‚à®",
    "longmord": "&lsaquo;longmord&rsaquo;",
    "longs": " É",
    "lrar": "‚Üî",
    "ltappr": "‚âæ",
    "ltflat": "‚à†",
    "ltlt": "‚â™",
    "lumlbl": "l",
    "male": "‚ôÇ",
    "mbwvow": "&lsaquo;mbwvow&rsaquo;",
    "mc": "c",
    "mcircbl": "&lsaquo;mcircbl&rsaquo;",
    "merc": "‚òø",
    "mfrown": "&lsaquo;mfrown&rsaquo;",
    "min": "‚àí",
    "minpl": "‚àì",
    "moonfq": "‚òΩ",
    "moonlq": "‚òæ",
    "mord": "&lsaquo;mord&rsaquo;",
    "mostra": "&lsaquo;mostra&rsaquo;",
    "msylab": "m",
    "msyllab": "&lsaquo;msyllab&rsaquo;",
    "natural": "‚ôÆ",
    "nb": "",
    "ncircbl": "&lsaquo;ncircbl&rsaquo;",
    "neq": "‚â†",
    "nfacu": "‚Ä≤",
    "nfasp": " ª",
    "nfasper": " ª",
    "nfbreve": "Àò",
    "nfced": "¬∏",
    "nfcirc": "ÀÜ",
    "nffrown": "‚å¢",
    "nfgra": "Àã",
    "nfhacek": "Àá",
    "nflenis": "·æø",
    "nfmac": "¬Ø",
    "nftilde": "Àú",
    "nfuml": "¬®",
    "nfundl": "&lsaquo;nfundl&rsaquo;",
    "ng": "≈ã",
    "nono": "&lsaquo;nono&rsaquo;",
    "notelem": "‚àâ",
    "nowy": "&lsaquo;nowy&rsaquo;",
    "oab": "‚å©",
    "ob": "{",
    "obar": "√∏",
    "obaracu": "«ø",
    "obarmac": "&lsaquo;obarmac&rsaquo;",
    "obigb": "{",
    "obigpren": "(",
    "obigsb": "[",
    "odsb": "„Äö",
    "oeamp": "&",
    "ohgcirc": "&lsaquo;ohgcirc&rsaquo;",
    "oldbeta": "&lsaquo;oldbeta&rsaquo;",
    "oldsemibr1": "&lsaquo;oldsemibr1&rsaquo;",
    "oldsemibr2": "&lsaquo;oldsemibr2&rsaquo;",
    "oneon3": "‚Öì",
    "oneon4": "¬º",
    "oneth": "√ê",
    "ope": "…õ",
    "opemac": "&lsaquo;opemac&rsaquo;",
    "opetilde": "&lsaquo;opetilde&rsaquo;",
    "opp": "‚òç",
    "oq": "`",
    "oqq": "‚Äú",
    "ormg": "&lsaquo;ormg&rsaquo;",
    "osb": "[",
    "ounce": "‚Ñ•",
    "ovparen": "‚å¢",
    "p": "‚Ä≤",
    "pa": "‚àÇ",
    "page": "P",
    "pall": " é",
    "paln": "…≤",
    "para2": "&lsaquo;para2&rsaquo;",
    "para3": "&lsaquo;para3&rsaquo;",
    "para4": "&lsaquo;para4&rsaquo;",
    "para5": "&lsaquo;para5&rsaquo;",
    "pauseo": "&lsaquo;pauseo&rsaquo;",
    "pauseu": "&lsaquo;pauseu&rsaquo;",
    "pbar": "p",
    "pcnt": "%",
    "per": "‚Ñò",
    "pharyng": " ï",
    "phi2": "œï",
    "pisces": "‚ôì",
    "planck": "ƒß",
    "plantinJ": "J",
    "pm": "¬±",
    "pmil": "‚Ä∞",
    "pp": "‚Ä≥",
    "ppp": "‚Ä¥",
    "psense": "‚ñ∏",
    "pstlg": "¬£",
    "q": "?",
    "qamets": "÷≥",
    "quaver": "‚ô™",
    "ragr": "&lsaquo;ragr&rsaquo;",
    "rar": "‚Üí",
    "rash": "·ö®",
    "rbbelow": "t",
    "rcircbl": "&lsaquo;rcircbl&rsaquo;",
    "rcircblmac": "&lsaquo;rcircblmac&rsaquo;",
    "rdot": "¬∑",
    "recipe": "‚Ñû",
    "repetn": "&lsaquo;repetn&rsaquo;",
    "revsc": "Àí",
    "rfa": "o",
    "rfatilde": "&lsaquo;rfatilde&rsaquo;",
    "rglots": " ï",
    "rhalfbr": "‚åâ",
    "rhshoe": "‚äÇ",
    "roasper": "&lsaquo;roasper&rsaquo;",
    "rsylab": "r",
    "rsyllab": "&lsaquo;rsyllab&rsaquo;",
    "ruasper": "&lsaquo;ruasper&rsaquo;",
    "runash": "F",
    "runicwynn": "·öπ",
    "runwyn": "·öπ",
    "rvow": "Àî",
    "sagit": "‚ôê",
    "sampi": "œ°",
    "saturn": "‚ôÑ",
    "sced": "≈ü",
    "schwafrbl": "&lsaquo;schwafrbl&rsaquo;",
    "scl": " ü",
    "scorpio": "‚ôè",
    "scrA": "A",
    "scrC": "C",
    "scrD": "&lsaquo;scrD&rsaquo;",
    "scrE": "E",
    "scrF": "F",
    "scrI": "I",
    "scrJ": "J",
    "scrL": "L",
    "scrM": "‚Ñ≥",
    "scrO": "O",
    "scrP": "P",
    "scrQ": "Q",
    "scrR": "‚Ñõ",
    "scrS": "S",
    "scrT": "T",
    "scrU": "&lsaquo;scrU&rsaquo;",
    "scrb": "b",
    "scrd": "d",
    "scrh": "h",
    "scrl": "l",
    "scruple": "‚Ñà",
    "sdd": "Àê",
    "segno": "&lsaquo;segno&rsaquo;",
    "segol": "÷∂",
    "semE": "‚àÉ",
    "semain1": "&lsaquo;semain1&rsaquo;",
    "semain2": "&lsaquo;semain2&rsaquo;",
    "semhe": "&lsaquo;semhe&rsaquo;",
    "semheth": "&lsaquo;semheth&rsaquo;",
    "semibr": "&lsaquo;semibr&rsaquo;",
    "semkaph": "&lsaquo;semkaph&rsaquo;",
    "semlamed1": "&lsaquo;semlamed1&rsaquo;",
    "semlamed2": "&lsaquo;semlamed2&rsaquo;",
    "semmem": "&lsaquo;semmem&rsaquo;",
    "semnun": "&lsaquo;semnun&rsaquo;",
    "sempe": "&lsaquo;sempe&rsaquo;",
    "semqoph1": "&lsaquo;semqoph1&rsaquo;",
    "semqoph2": "&lsaquo;semqoph2&rsaquo;",
    "semqoph3": "&lsaquo;semqoph3&rsaquo;",
    "semresh": "&lsaquo;semresh&rsaquo;",
    "semtav1": "&lsaquo;semtav1&rsaquo;",
    "semtav2": "&lsaquo;semtav2&rsaquo;",
    "semtav3": "&lsaquo;semtav3&rsaquo;",
    "semtav4": "&lsaquo;semtav4&rsaquo;",
    "semyod": "&lsaquo;semyod&rsaquo;",
    "semzayin1": "&lsaquo;semzayin1&rsaquo;",
    "semzayin2": "&lsaquo;semzayin2&rsaquo;",
    "semzayin3": "&lsaquo;semzayin3&rsaquo;",
    "sh": " É",
    "shadda": "Ôπº",
    "sharp": "‚ôØ",
    "sheva": "÷∞",
    "shti": "…™",
    "shtibar": "…™",
    "shtlong1": "&lsaquo;shtlong1&rsaquo;",
    "shtlong2": "&lsaquo;shtlong2&rsaquo;",
    "shtsyll": "‚à™",
    "shtsyllmac": "&lsaquo;shtsyllmac&rsaquo;",
    "shtu": " ä",
    "sidetri": "‚ä≤",
    "sigmatau": "œõ",
    "since": "‚àµ",
    "sixon2": "6/2",
    "sixon4": "6/4",
    "sixon8": "6/8",
    "slge": "‚â•",
    "slle": "‚â§",
    "sm": "Àà",
    "smR": " Ä",
    "smY": " è",
    "smm": "Àå",
    "sp": "",
    "spade": "‚ô†",
    "sqbreve": "&lsaquo;sqbreve&rsaquo;",
    "sqquav": "&lsaquo;sqquav&rsaquo;",
    "sqrt": "‚àö",
    "square": "‚ñ°",
    "squaver": "&lsaquo;squaver&rsaquo;",
    "ssChi": "Œß",
    "ssIota": "Œô",
    "ssOmicron": "Œü",
    "ssPi": "Œ†",
    "ssRho": "Œ°",
    "ssSigma": "Œ£",
    "ssTau": "Œ§",
    "star": "*",
    "stlig": "Ô¨Ö",
    "sun": "‚òâ",
    "subsr": "‚Üí",
    "supa": "<sup>a</sup>",
    "supc": "<sup>c</sup>",
    "supd": "<sup>d</sup>",
    "supg": "<sup>g</sup>",
    "supgt": "ÀÉ",
    "suph": "<sup>h</sup>",
    "supi": "<sup>i</sup>",
    "supl": "<sup>l</sup>",
    "suplt": "ÀÇ",
    "supm": "<sup>m</sup>",
    "supr": "<sup>r</sup>",
    "sups": "<sup>s</sup>",
    "supt": "<sup>t</sup>",
    "supu": "<sup>u</sup>",
    "supw": "<sup>w</sup>",
    "supy": "<sup>y</sup>",
    "supz": "<sup>z</sup>",
    "sur": " ≥",
    "swast": "&lsaquo;swast&rsaquo;",
    "swing": "‚àº",
    "taur": "‚ôâ",
    "tced": "≈£",
    "th": "√æ",
    "thbar": "√æ",
    "thdotab": "&lsaquo;thdotab&rsaquo;",
    "thinqm": "?",
    "threeon16": "3/16",
    "threeon2": "3/2",
    "threeon4": "¬æ",
    "threeon8": "‚Öú",
    "tie": "&lsaquo;tie&rsaquo;",
    "tittle": "‚ã∞",
    "tri": "‚àÜ",
    "trli": "‚Äñ",
    "ts": "\u2009",
    "two2n": "&lsaquo;two2n&rsaquo;",
    "twoon4": "2/4",
    "twothird": "‚Öî",
    "ubar": "u",
    "udA": "‚àÄ",
    "udT": "‚ä•",
    "uda": "…ê",
    "udatilde": "&lsaquo;udatilde&rsaquo;",
    "udh": "…•",
    "udpsi": "‚ãî",
    "udqm": "¬ø",
    "udtr": "‚àá",
    "udw": " ç",
    "ufrbl": "&lsaquo;ufrbl&rsaquo;",
    "uncU": "&lsaquo;uncU&rsaquo;",
    "undl": "Àç",
    "union": "‚à™",
    "uumlsc": "√º",
    "vavpath": "◊ï",
    "vavsheva": "◊ï",
    "vb": "|",
    "vddd": "‚ãÆ",
    "vdftheta": "&theta;",
    "versicle1": "‚Ñ£",
    "versicle2": "‚Ñ£",
    "vinc": "¬Ø",
    "virgo": "‚ôç",
    "vpal": "…ü",
    "vvf": "…£",
    "wapos": "&lsaquo;wapos&rsaquo;",
    "wavyeq": "‚âà",
    "woqab": "&lsaquo;woqab&rsaquo;",
    "wyn": "∆ø",
    "ye": "&lsaquo;ye&rsaquo;",
    "ygh": " í",
    "yt": "&lsaquo;yt&rsaquo;",
    "zbbelow": "j",
    "zced": "z",
}
"""Replacements for non-standard entities (special characters)

From https://plan9.io/sources/plan9/sys/src/cmd/dict/oed.c
merged with https://github.com/Barjak/OED_unpack_tools.py/blob/master/parse.py
and without HTML entites in `html.entities.entitydefs`
"""

extra_letters = {
    "ae": "√¶",
    "Ae": "√Ü",
    "nu": "ŒΩ",
    "oe": "≈ì",
    "Oe": "≈í",
    "reva": "…í",
    "revC": "∆Ü",
    "revc": "…î",
    "revope": "…ú",
    "revr": "…π",
    "revv": " å",
    "schwa": "…ô",
    "zh": " í",
}
combine_chars = {
    "acu": "\u0301",
    "acdbl": "\u030b",
    "ang": "\u030a",
    "bar": "\u0304",
    "barab": "\u0304",
    "bbelow": "\u0332",
    "breve": "\u0306",
    "circsc": "\u0302",
    "circ": "\u0302",
    "dabove": "\u0307",
    "dbelow": "\u0323",
    "dotab": "\u0307",
    "dotbl": "\u0323",
    "grave": "\u0300",
    "gravdbl": "\u030f",
    "gra": "\u0300",
    "hacekb": "\u030c",
    "hacek": "\u030c",
    "hook": "\u0328",
    "mac": "\u0304",
    "tildepr": "\u0303",
    "tilde": "\u0303",
    "umlsc": "\u0308",
    "uml": "\u0308",
    "undl": "\u0332",
    "undtilde": "\u0330",
}
combine_chars_re = "(?:" + "|".join(combine_chars.keys()) + ")"
combine_chars_re_extra = (
    f"(?i)^([a-z]|{'|'.join(extra_letters.keys())})({combine_chars_re}+)$"
)
extra_letters_grk = {
    "aa": "Œ±",
    "Aa": "Œë",
    "ga": "Œ±",
    "gA": "Œë",
    "a": "Œ±",
    "A": "Œë",
    "ge": "Œµ",
    "gh": "Œ∑",
    "gi": "Œπ",
    "go": "Œø",
    "gu": "œÖ",
    "gw": "œâ",
    "e": "Œµ",
    "E": "Œï",
    "h": "Œ∑",
    "H": "Œó",
    "w": "œâ",
    "W": "Œ©",
    "u": "œÖ",
    "U": "Œ•",
    "r": "œÅ",
    "R": "Œ°",
    "o": "Œø",
    "O": "Œü",
}
combine_chars_grk = {
    **combine_chars,
    "asper": "\u0485",
    "frownb": "\u0342",
    "frown": "\u0342",
    "isub": "\u0345",
    "lenis": "\u0486",
}
combine_chars_grk_re = "(?:" + "|".join(combine_chars_grk.keys()) + ")"
combine_chars_grk_re_extra = (
    f"(?i)^({'|'.join(extra_letters_grk.keys())})({combine_chars_grk_re}+)$"
)

def _grk_entity_name_to_unicode(ent):
    ent = re.sub(r"^epsilon", "ge", ent)
    ent = re.sub(r"^eta", "gh", ent)
    m = re.match(combine_chars_grk_re_extra, ent)
    if m is None:
        return None
    res = m.group(1)
    for r1, r2 in extra_letters_grk.items():
        res = res.replace(r1, r2)
    combs = m.group(2)
    l_combs = len(combs)
    for m in re.finditer(combine_chars_grk_re, combs):
        cc = m.group(0)
        res += combine_chars_grk[cc]
        l_combs -= len(cc)
    if l_combs > 0:
        print(ent, combs, res)
        sys.exit()
    return unicodedata.normalize("NFC", res)

def entity_name_to_unicode(ent):
    if ent in extra_letters:
        return extra_letters[ent]
    m = re.match(combine_chars_re_extra, ent)
    if m is None:
        return _grk_entity_name_to_unicode(ent)
    res = m.group(1)
    for r1, r2 in extra_letters.items():
        res = res.replace(r1, r2)
    combs = m.group(2)
    for m in re.finditer(combine_chars_re, combs):
        res += combine_chars[m.group(0)]
    return unicodedata.normalize("NFC", res)

class Plugin(BglPlugin):
    def post_setup(self, cursor):
        BglPlugin.post_setup(self, cursor)

        res_dirname = os.path.join(self.output_directory, "res")
        for f in os.listdir(res_dirname):
            if f not in symbol_img and f in image_to_html:
                os.remove(os.path.join(res_dirname, f))
        self.stages['Processor'] = SoedProcessor(self)

class SoedProcessor(BglProcessor):
    def do_bgl_definition(self, definition, term, alts):
        definition = BglProcessor.do_bgl_definition(self, definition, term, alts)

        def cb_fun(m):
            ent = m.group(1)
            if ent in entity_table:
                res = entity_table[ent]
                if res.startswith("&lsaquo;"):
                    print(term)
                    print(ent, res)
                    print(definition.replace(ent, f'\033[93m{ent}\033[0m'))
                    print()
                    # sys.exit()
            else:
                res = entity_name_to_unicode(ent)
                if res is None:
                    print(term)
                    print("Unknown entity", ent)
                    print(definition.replace(ent, f'\033[93m{ent}\033[0m'))
                    print()
                    # sys.exit()
            return res


        re.sub(r"&amp;([A-Za-z0-9]+);", cb_fun, definition)
        definition = re.sub(r"&([^;]+);", r"##\1||", definition)
        parser = etree.HTMLParser(encoding="utf-8")
        doc = pq(etree.fromstring(definition, parser=parser))

        def _replace_img_el(el, doc=doc):
            if doc(el).outerHtml() is None:
                return ""
            assert len(doc(el).parents("strong")) == 0

            img_src = doc(el).attr("src").strip()
            replacement = el
            if img_src in image_to_html:
                replacement = doc("<span/>").html(image_to_html[img_src])
            elif img_src in symbol_img:
                replacement.addClass("_dictmaster_touched")
            else:
                print(term)
                print(img_src)
                print(definition.replace(img_src, f'\033[93m{img_src}\033[0m'))
                sys.exit()
            return replacement
        doc_replace_els(doc, "img:not(._dictmaster_touched)", _replace_img_el)
        doc("img").removeAttr("class")

        new_el = doc("<b/>").css({
            "background-color": "#b55",
            "color": "#fff",
            "padding": "0.1ex 0.5ex 0",
            "margin-right": "0.5ex",
        })
        doc_rewrap_els(doc, "num", new_el.outerHtml(), textify=True)

        definition = doc.html()

        # remove empty strong/div tags
        regex = [
            [r"##([^\|]+)\|\|",r"&\1;"],
            [r"(?i)<(strong|div)[^>]*>\s*</(strong|div)>", ""],
        ]
        for r in regex:
            definition = re.sub(r[0], r[1], definition)

        return doc.html()
